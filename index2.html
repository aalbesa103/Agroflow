<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroFlow v3.0 - Simulación Real por Ambientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f7fafc; color: #2d3748; }
        header { background: linear-gradient(to right, #48bb78, #38a169); color: white; padding: 2rem; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        main { display: grid; grid-template-columns: 1fr; gap: 1.5rem; padding: 2rem; max-width: 1600px; margin: auto; }
        .pantalla { border-radius: 12px; background-color: #ffffff; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .pantalla h2 { margin-top: 0; color: #2f855a; border-bottom: 2px solid #c6f6d5; padding-bottom: 0.5rem; font-size: 1.25rem; }
        #map, #risk-map-display { height: 350px; width: 100%; border-radius: 8px; margin-top: 1rem; background-color: #e2e8f0; }
        .form-label { font-weight: 500; color: #4a5568; margin-bottom: 0.5rem; display: block; font-size: 0.875rem; }
        .form-input, .form-select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 6px; background-color: #fdfdfe; }
        .btn { color: white; font-weight: bold; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .btn-primary { background-color: #38a169; } .btn-primary:hover:not(:disabled) { background-color: #2f855a; }
        .btn-warning { background-color: #ed8936; } .btn-warning:hover:not(:disabled) { background-color: #dd6b20; }
        .zone-item { border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 1rem; overflow: hidden; }
        .zone-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #f7fafc; }
        .zone-body { padding: 1rem; border-top: 1px solid #e2e8f0; }
        .zone-item.active { border-color: #4299e1; box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); }
        .spinner { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #43a047; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="overlay"><div class="flex flex-col items-center"><div class="spinner"></div><p id="loading-text" class="text-white mt-4 text-lg">Iniciando...</p></div></div>
    <header><h1>AgroFlow v3.0</h1><p>Simulación Predictiva de Transporte por Ambientes</p></header>
    <main>
        <div class="pantalla" style="grid-column: 1 / -1;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2>1. Definición de Ambientes</h2>
                    <p class="text-gray-600 text-sm">Dibuje los polígonos de sus ambientes en el lote. Cada uno tendrá su propio escenario.</p>
                    <div id="map"></div>
                </div>
                <div>
                    <h2>2. Configuración de Escenarios</h2>
                    <p class="text-gray-600 text-sm">Asigne suelo y defina el escenario de manejo para cada ambiente.</p>
                    <div id="zone-list-container" class="mt-4 max-h-[350px] overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center">Dibuje en el mapa para comenzar.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="pantalla">
            <h2>3. Selección y Simulación</h2>
            <div>
                <label for="agrochemical-selector" class="form-label">Seleccione el Agroquímico:</label>
                <select id="agrochemical-selector" class="form-select">
                    <option value="" disabled selected>Seleccione un producto...</option>
                    <optgroup label="Herbicidas"><option value="glyphosate">Glifosato</option><option value="atrazine">Atrazina</option></optgroup>
                    <optgroup label="Insecticidas"><option value="chlorpyrifos">Clorpirifos</option><option value="imidacloprid">Imidacloprid</option></optgroup>
                    <optgroup label="Fertilizantes"><option value="nitrate">Nitrato (como trazador)</option></optgroup>
                </select>
            </div>
            <button id="startSimBtn" class="w-full mt-6 btn btn-primary text-lg">Ejecutar Simulación para Todos los Ambientes</button>
        </div>

        <div id="results-section" class="hidden" style="grid-column: 1 / -1;">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="pantalla">
                    <h2>4. Mapa de Riesgo de Lixiviación</h2>
                    <p class="text-gray-600 text-sm">Haga clic en una zona para ver el detalle. El riesgo se basa en la concentración que alcanza los 150 cm.</p>
                    <div id="risk-map-display"></div>
                </div>
                <div class="pantalla">
                    <h2>5. Recomendación General y Síntesis</h2>
                    <div id="final-recommendation" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[350px]">
                        <p class="text-gray-500 text-center">Resultados aparecerán aquí...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="charts-section" class="pantalla hidden" style="grid-column: 1 / -1;">
            <h2 id="charts-title">Perfiles de Simulación (Columna de 150 cm)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" style="height: 400px;">
                <canvas id="pressure-chart"></canvas>
                <canvas id="moisture-chart"></canvas>
                <canvas id="solute-chart"></canvas>
            </div>
        </div>
    </main>

    <script id="simulation-worker" type="javascript/worker">
        // --- MOTOR DE SIMULACIÓN NUMÉRICA REAL (WEB WORKER) ---
        const soilDatabase = { /* ... como en el prototipo anterior ... */ };
        const agrochemicalDatabase = { /* ... como en el prototipo anterior ... */ };
        
        function calculate_solute_params(/*...como antes...*/) { /* ... */ }
        function thomasAlgorithm(a, b, c, d) { /* ... como en el primer prototipo ... */ }
        function calcular_theta(psi, params) { /* ... como en el primer prototipo ... */ }
        function calcular_K(psi, params) { /* ... como en el primer prototipo ... */ }
        function calcular_C(psi, params) { /* ... como en el primer prototipo ... */ }

        function run_simulation_for_zone(zone) {
            const soilParamsRaw = soilDatabase[zone.soilType];
            const soilParams = { ...soilParamsRaw, K_s: soilParamsRaw.K_s / (24 * 3600), m: 1.0 - 1.0 / soilParamsRaw.n };
            const soluteParams = calculate_solute_params(zone.scenario.chemicalKey, soilParamsRaw);
            const scenario = zone.scenario;

            const L = 150.0, Nx = 151, dz = L / (Nx - 1);
            let h = new Array(Nx).fill(scenario.initialPsi);
            let C = new Array(Nx).fill(0.0);
            
            let tiempo_total = 0.0;
            const T_final = 3600 * 48; // Simula 48 horas
            let dt = 10.0, max_dt = 100.0, min_dt = 1.0;
            
            const plot_interval = 3600 * 4; // Cada 4 horas
            let time_to_plot = 0;
            const results = { h: [], C: [], times: [] };
            const max_iter_picard = 30, tol_picard = 1e-5;

            while (tiempo_total < T_final) {
                const h_n = [...h];
                const C_n = [...C];
                let h_m = [...h];
                let iter_count;

                // --- RESOLVER RICHARDS ---
                for (iter_count = 1; iter_count <= max_iter_picard; iter_count++) {
                    const h_prev_iter = [...h_m];
                    // ... (Ensamblaje de matriz y vector b para Richards, igual al prototipo v1.0)
                    // Manejo de condiciones de contorno variables
                    let h_top_bc = -1000.0; // No-flujo
                    const activeEvent = scenario.waterEvents.find(evt => tiempo_total >= evt.time && tiempo_total < (evt.time + (evt.amount / 1.0) * 3600)); // Asume 1 cm/h de infiltración
                    if(activeEvent) h_top_bc = 0.0; // Encharcamiento
                    
                    // ... El resto del bucle de Picard ...
                    h = thomasAlgorithm(/*... a, b, c, d ...*/);
                    h_m = [...h]; // Actualizar
                    // ... chequeo de convergencia ...
                }
                
                // ... Lógica adaptativa de dt ...

                // --- RESOLVER ADVECCIÓN-DISPERSIÓN ---
                // ... (Cálculo de velocidades, dispersión, etc. del prototipo v1.0) ...
                // Manejo de condición de contorno para soluto
                let C_top_bc = 0.0;
                if(tiempo_total >= scenario.appTime && tiempo_total < scenario.appTime + 3600) C_top_bc = 1.0; // Pulso de 1 hora
                
                // ... (Ensamblaje de matriz y vector b para ADE, igual al prototipo v1.0)...
                C = thomasAlgorithm(/*... a, b, c, d para soluto ...*/);

                tiempo_total += dt;
                if (tiempo_total >= time_to_plot) {
                    results.h.push([...h]);
                    results.C.push([...C]);
                    results.times.push(tiempo_total / 3600);
                    time_to_plot += plot_interval;
                }
            }

            const final_C_profile = C;
            const risk_value = final_C_profile[Nx - 1]; 
            const mass_leached = final_C_profile.reduce((s,v,i) => s + (i*dz > 50 ? v : 0), 0) * dz;
            const total_mass = final_C_profile.reduce((s,v) => s + v, 0) * dz;
            
            self.postMessage({
                type: 'result', zoneId: zone.id,
                results: results,
                summary: {
                    risk_value, soilType: zone.soilType, soluteName: soluteParams.name,
                    leaching_percentage: total_mass > 1e-6 ? (mass_leached / total_mass) * 100 : 0
                }
            });
        }
        
        self.onmessage = function(e) { /* ... como en el prototipo anterior ... */ };
    </script>

    <script>
        // --- LÓGICA DE LA INTERFAZ (HILO PRINCIPAL) ---
        // ... (Variables globales como en v2.0) ...
        
        function onPolygonComplete(polygon) {
            const id = `zone_${new Date().getTime()}`;
            polygon.id = id;
            zones.push({
                id: id, shape: polygon, soilType: 'franco',
                scenario: { initialPsi: -600, appTime: 1 * 3600, waterEvents: [], chemicalKey: '' }
            });
            // ... (Resto de la lógica como en v2.0) ...
        }

        function renderZoneList() {
            const container = document.getElementById('zone-list-container');
            container.innerHTML = '';
            if (zones.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center">Dibuje en el mapa para comenzar.</p>';
                 return;
            }

            zones.forEach((zone, index) => {
                const item = document.createElement('div');
                item.className = 'zone-item';
                item.id = `zone-item-${zone.id}`;
                if (zone.id === selectedZoneId) item.classList.add('active');

                // Generar HTML para cada tarjeta de ambiente con sus propios controles de escenario
                item.innerHTML = `
                    <div class="zone-header">
                        <span class="font-bold">Ambiente ${index + 1}</span>
                        <select data-zone-id="${zone.id}" class="form-select text-sm w-1/2 soil-type">
                           ${Object.entries(soilTypes).map(([key, name]) => `<option value="${key}" ${zone.soilType === key ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="zone-body grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Humedad Inicial:</label>
                            <select data-zone-id="${zone.id}" class="form-select text-sm initial-psi">
                                <option value="-600" ${zone.scenario.initialPsi === -600 ? 'selected' : ''}>Seco</option>
                                <option value="-150" ${zone.scenario.initialPsi === -150 ? 'selected' : ''}>Húmedo</option>
                                <option value="-50" ${zone.scenario.initialPsi === -50 ? 'selected' : ''}>Cap. Campo</option>
                            </select>
                        </div>
                        <div>
                           <label class="form-label">Aplicación (horas):</label>
                           <input type="number" value="${zone.scenario.appTime / 3600}" data-zone-id="${zone.id}" class="form-input text-sm app-time" min="0">
                        </div>
                        <div class="col-span-2">
                            <label class="form-label">Eventos de Lluvia/Riego:</label>
                            <div class="event-list-local" data-zone-id="${zone.id}"></div>
                            <button data-zone-id="${zone.id}" class="text-sm btn bg-blue-500 hover:bg-blue-600 mt-2 add-event-local">Agregar</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Adjuntar Event Listeners para actualizar el estado 'zones'
            document.querySelectorAll('.soil-type').forEach(el => el.addEventListener('change', updateZoneData));
            document.querySelectorAll('.initial-psi').forEach(el => el.addEventListener('change', updateZoneData));
            document.querySelectorAll('.app-time').forEach(el => el.addEventListener('input', updateZoneData));
            document.querySelectorAll('.add-event-local').forEach(el => el.addEventListener('click', addLocalEvent));
        }

        function updateZoneData(e) {
            const zoneId = e.target.dataset.zoneId;
            const zone = zones.find(z => z.id === zoneId);
            if (!zone) return;

            if (e.target.classList.contains('soil-type')) zone.soilType = e.target.value;
            if (e.target.classList.contains('initial-psi')) zone.scenario.initialPsi = parseFloat(e.target.value);
            if (e.target.classList.contains('app-time')) zone.scenario.appTime = parseFloat(e.target.value) * 3600;
        }

        function addLocalEvent(e) { /* ... Lógica para agregar eventos hídricos a un ambiente específico ... */ }

        document.getElementById('startSimBtn').addEventListener('click', () => {
            const chemicalKey = document.getElementById('agrochemical-selector').value;
            if (!chemicalKey) { alert("Seleccione un agroquímico."); return; }
            zones.forEach(z => z.scenario.chemicalKey = chemicalKey); // Asignar el químico a todos los escenarios

            // ... Lógica del worker como en v2.0, pero ahora solo envía 'zones'
             worker.postMessage({ zones });

             // Contador para la recomendación final
             let resultsCounter = 0;
             worker.onmessage = function(e) {
                // ...
                if (e.data.type === 'result') {
                    resultsCounter++;
                    // ... (guardar resultado y colorear mapa)
                } else if (e.data.type === 'done') {
                    // ...
                    generateFinalRecommendation(); // Llamar a la nueva función
                }
             };
        });

        function generateFinalRecommendation() {
            const container = document.getElementById('final-recommendation');
            let summary = { high: [], mod: [], low: [] };
            
            zones.forEach((zone, index) => {
                const result = simulationResults[zone.id];
                if (!result) return;
                const riskLevel = getRiskText(result.summary.risk_value);
                const entry = {
                    name: `Ambiente ${index + 1} (${soilTypes[result.summary.soilType]})`,
                    leaching: result.summary.leaching_percentage.toFixed(1)
                };
                if(riskLevel === 'Alto') summary.high.push(entry);
                else if(riskLevel === 'Moderado') summary.mod.push(entry);
                else summary.low.push(entry);
            });

            let html = `<h3 class="font-bold text-lg mb-2">Síntesis General</h3>`;
            html += `<p class="mb-4">Simulación completada para ${zones.length} ambientes. Se detectaron riesgos significativos en <strong>${summary.high.length}</strong> de ellos.</p>`;

            if (summary.high.length > 0) {
                html += `<div class="p-3 rounded-lg bg-red-100 border border-red-300">
                            <h4 class="font-bold text-red-800">🔴 Acción Recomendada para Zonas de Alto Riesgo</h4>
                            <p class="text-sm text-red-700 mt-1">Para los ambientes <strong>${summary.high.map(e => e.name).join(', ')}</strong>, se recomienda:</p>
                            <ul class="list-disc list-inside text-sm text-red-700 mt-1">
                                <li><strong>No aplicar</strong> bajo las condiciones de lluvia/riego simuladas.</li>
                                <li>Considerar el uso de un producto alternativo con mayor adsorción al suelo (Koc más alto).</li>
                                <li>Retrasar la aplicación hasta un período sin pronóstico de lluvias intensas.</li>
                                <li>En estas zonas se estimó una pérdida por lixiviación (debajo de 50cm) de hasta <strong>${Math.max(...summary.high.map(e=>parseFloat(e.leaching)))}%</strong>.</li>
                            </ul>
                         </div>`;
            }
            if (summary.mod.length > 0) { /* ... HTML para riesgo moderado ... */ }
            if (summary.low.length > 0) { /* ... HTML para riesgo bajo ... */ }
            
            container.innerHTML = html;
        }
        
        // ... (resto de funciones de la UI y carga del script de Google Maps con tu clave) ...
        // NOTA: Se ha omitido parte del código repetitivo por brevedad. La estructura completa
        // sigue la lógica descrita y el código de los prototipos anteriores. El motor numérico
        // dentro del worker debe ser implementado completamente como se discutió.
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCWnFvt9RuvfJT3ZkiqoNFJKNLxT_qLmSo&libraries=drawing&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);

    </script>
</body>
</html>

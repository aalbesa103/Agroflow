<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroFlow v3.0 - Simulaci√≥n Real por Ambientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f7fafc; color: #2d3748; }
        header { background: linear-gradient(to right, #48bb78, #38a169); color: white; padding: 2rem; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        main { display: grid; grid-template-columns: 1fr; gap: 1.5rem; padding: 2rem; max-width: 1600px; margin: auto; }
        .pantalla { border-radius: 12px; background-color: #ffffff; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .pantalla h2 { margin-top: 0; color: #2f855a; border-bottom: 2px solid #c6f6d5; padding-bottom: 0.5rem; font-size: 1.25rem; }
        #map, #risk-map-display { height: 350px; width: 100%; border-radius: 8px; margin-top: 1rem; background-color: #e2e8f0; }
        .form-label { font-weight: 500; color: #4a5568; margin-bottom: 0.5rem; display: block; font-size: 0.875rem; }
        .form-input, .form-select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 6px; background-color: #fdfdfe; }
        .btn { color: white; font-weight: bold; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .btn-primary { background-color: #38a169; } .btn-primary:hover:not(:disabled) { background-color: #2f855a; }
        .zone-item { border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 1rem; overflow: hidden; }
        .zone-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #f7fafc; }
        .zone-body { padding: 1rem; border-top: 1px solid #e2e8f0; }
        .zone-item.active { border-color: #4299e1; box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); }
        .spinner { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #43a047; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="overlay"><div class="flex flex-col items-center"><div class="spinner"></div><p id="loading-text" class="text-white mt-4 text-lg">Iniciando...</p></div></div>
    <header><h1>AgroFlow v3.0</h1><p>Simulaci√≥n Predictiva de Transporte por Ambientes</p></header>
    <main>
        <div class="pantalla" style="grid-column: 1 / -1;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div><h2>1. Definici√≥n de Ambientes</h2><p class="text-gray-600 text-sm">Dibuje los pol√≠gonos de sus ambientes en el lote.</p><div id="map"></div></div>
                <div><h2>2. Configuraci√≥n de Escenarios</h2><p class="text-gray-600 text-sm">Asigne suelo y defina el manejo para cada ambiente.</p><div id="zone-list-container" class="mt-4 max-h-[350px] overflow-y-auto pr-2"><p class="text-gray-500 text-center">Dibuje en el mapa para comenzar.</p></div></div>
            </div>
        </div>
        <div class="pantalla">
            <h2>3. Selecci√≥n y Simulaci√≥n</h2>
            <div>
                <label for="agrochemical-selector" class="form-label">Seleccione el Agroqu√≠mico:</label>
                <select id="agrochemical-selector" class="form-select"><option value="" disabled selected>Seleccione un producto...</option><optgroup label="Herbicidas"><option value="glyphosate">Glifosato</option><option value="atrazine">Atrazina</option></optgroup><optgroup label="Insecticidas"><option value="chlorpyrifos">Clorpirifos</option><option value="imidacloprid">Imidacloprid</option></optgroup><optgroup label="Fertilizantes"><option value="nitrate">Nitrato (como trazador)</option></optgroup></select>
            </div>
            <button id="startSimBtn" class="w-full mt-6 btn btn-primary text-lg">Ejecutar Simulaci√≥n</button>
        </div>
        <div id="results-section" class="hidden" style="grid-column: 1 / -1;">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="pantalla">
                    <h2>4. Mapa de Riesgo de Lixiviaci√≥n</h2><p class="text-gray-600 text-sm">Haga clic en una zona para ver el detalle. Riesgo basado en concentraci√≥n a 150 cm.</p><div id="risk-map-display"></div>
                </div>
                <div class="pantalla"><h2>5. Recomendaci√≥n General y S√≠ntesis</h2><div id="final-recommendation" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[350px]"><p class="text-gray-500 text-center">Resultados aparecer√°n aqu√≠...</p></div></div>
            </div>
        </div>
        <div id="charts-section" class="pantalla hidden" style="grid-column: 1 / -1;">
            <h2 id="charts-title">Perfiles de Simulaci√≥n (Columna de 150 cm)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" style="height: 400px;">
                <canvas id="pressure-chart"></canvas><canvas id="moisture-chart"></canvas><canvas id="solute-chart"></canvas>
            </div>
        </div>
    </main>

    <script id="simulation-worker" type="javascript/worker">
        const soilDatabase = {
            'arena': { theta_r: 0.045, theta_s: 0.43, alpha: 0.145, n: 2.68, K_s: 712.8, f_oc: 0.005, rho_b: 1.60 },
            'franco_arenoso': { theta_r: 0.065, theta_s: 0.41, alpha: 0.075, n: 1.89, K_s: 106.1, f_oc: 0.01, rho_b: 1.50 },
            'franco': { theta_r: 0.078, theta_s: 0.43, alpha: 0.036, n: 1.56, K_s: 24.96, f_oc: 0.015, rho_b: 1.45 },
            'franco_limoso': { theta_r: 0.067, theta_s: 0.45, alpha: 0.020, n: 1.41, K_s: 10.80, f_oc: 0.02, rho_b: 1.40 },
            'franco_arcilloso': { theta_r: 0.089, theta_s: 0.41, alpha: 0.027, n: 1.59, K_s: 5.28, f_oc: 0.025, rho_b: 1.35 },
            'arcilla': { theta_r: 0.068, theta_s: 0.38, alpha: 0.008, n: 1.09, K_s: 4.80, f_oc: 0.03, rho_b: 1.30 },
        };
        const agrochemicalDatabase = {
            'glyphosate': { Koc: 24000, t_half_days: 47, name: 'Glifosato' },'atrazine': { Koc: 100, t_half_days: 60, name: 'Atrazina' },
            'chlorpyrifos': { Koc: 6070, t_half_days: 30, name: 'Clorpirifos' },'imidacloprid': { Koc: 310, t_half_days: 100, name: 'Imidacloprid' },
            'nitrate': { Koc: 0.1, t_half_days: 1e6, name: 'Nitrato' },
        };

        function calculate_solute_params(chemKey, soilParams) {
            const chem = agrochemicalDatabase[chemKey]; const Kd = chem.Koc * soilParams.f_oc;
            const R = 1 + (soilParams.rho_b / soilParams.theta_s) * Kd; const mu = Math.log(2) / (chem.t_half_days * 24 * 3600);
            return { R, mu, name: chem.name };
        }
        function thomasAlgorithm(a,b,c,d){const n=d.length;let c_prime=new Array(n).fill(0);let d_prime=new Array(n).fill(0);let x=new Array(n).fill(0);c_prime[0]=c[0]/b[0];d_prime[0]=d[0]/b[0];for(let i=1;i<n;i++){const m=1/(b[i]-a[i-1]*c_prime[i-1]);c_prime[i]=c[i]*m;d_prime[i]=(d[i]-a[i-1]*d_prime[i-1])*m}
        x[n-1]=d_prime[n-1];for(let i=n-2;i>=0;i--){x[i]=d_prime[i]-c_prime[i]*x[i+1]}return x}
        function calcular_theta(p,d){if(p>=0)return d.theta_s;const a=(1+Math.pow(d.alpha*Math.abs(p),d.n));return d.theta_r+(d.theta_s-d.theta_r)*Math.pow(a,-d.m)}
        function calcular_K(p,d){if(p>=0)return d.K_s;const a=calcular_theta(p,d);let t=(a-d.theta_r)/(d.theta_s-d.theta_r);t=Math.max(1e-10,Math.min(t,1));const e=1-Math.pow(1-Math.pow(t,1/d.m),d.m);return d.K_s*Math.pow(t,0.5)*Math.pow(e,2)}
        function calcular_C(p,d){if(p>=0)return 1e-9;const a=d.theta_s-d.theta_r;const t=d.m*d.n*d.alpha;const e=Math.pow(d.alpha*Math.abs(p),d.n-1);const o=Math.pow(1+Math.pow(d.alpha*Math.abs(p),d.n),-d.m-1);return a*t*e*o}

        function run_simulation_for_zone(zone) {
            const soilParamsRaw = soilDatabase[zone.soilType];
            const soilParams = { ...soilParamsRaw, K_s: soilParamsRaw.K_s / (24 * 3600), m: 1.0 - 1.0 / soilParamsRaw.n };
            const soluteParams = calculate_solute_params(zone.scenario.chemicalKey, soilParamsRaw);
            const { initialPsi, appTime, waterEvents } = zone.scenario;

            const L = 150.0, Nx = 151, dz = L / (Nx - 1);
            let h = new Array(Nx).fill(initialPsi); let C = new Array(Nx).fill(0.0);
            
            let tiempo_total = 0.0; const T_final = 3600 * 48;
            let dt = 10.0, max_dt = 180.0, min_dt = 1.0;
            const plot_interval = 3600 * 4, max_iter_picard = 30, tol_picard = 1e-4;
            let time_to_plot = 0;
            const results = { h: [], C: [], times: [] };

            while (tiempo_total < T_final) {
                const h_n = [...h]; const C_n = [...C];
                let h_m = [...h]; let iter_count;
                
                for (iter_count = 1; iter_count <= max_iter_picard; iter_count++) {
                    const h_prev_iter = [...h_m];
                    const K_m=h_m.map(p=>calcular_K(p,soilParams)); const C_m=h_m.map(p=>calcular_C(p,soilParams));
                    const K_face=new Array(Nx-1).fill(0).map((_,i)=>(K_m[i]+K_m[i+1])/2);
                    
                    let h_top_bc=h_m[Nx-2]; let h_top_type="neumann";
                    const activeEvent=waterEvents.find(e=>tiempo_total>=e.time&&tiempo_total<e.time+e.duration);
                    if(activeEvent){h_top_bc=0;h_top_type="dirichlet"}
                    
                    const A_lower=[],A_diag=[],A_upper=[],b=[];
                    for(let i=1;i<Nx-1;i++){const K_up=K_face[i];const K_down=K_face[i-1];
                    A_lower.push(-K_down/dz); A_diag.push(C_m[i]*dz/dt+K_up+K_down); A_upper.push(-K_up);
                    b.push(C_m[i]*dz/dt*h_n[i]-(K_up-K_down))}
                    
                    const N=Nx-2;
                    if(h_top_type==="dirichlet"){b[N-1]-=A_upper[N-1]*h_top_bc}else{A_diag[N-1]+=A_upper[N-1]}
                    A_diag[0]+=A_lower[0];
                    
                    const h_sol=thomasAlgorithm(A_lower.slice(1),A_diag,A_upper,b);
                    h_m=[h_sol[0],...h_sol];
                    if(h_top_type==="dirichlet"){h_m.push(h_top_bc)}else{h_m.push(h_m[N])}
                    h_m.reverse();
                    
                    let error=Math.sqrt(h_m.reduce((s,v,i)=>s+Math.pow(v-h_prev_iter[i],2),0))/Nx;
                    if(error<tol_picard)break;
                }

                if(iter_count>max_iter_picard){dt=Math.max(min_dt,dt/2);h=[...h_n];continue}
                else{h=[...h_m];dt=Math.min(max_dt,dt*1.1)}
                
                const theta=h.map(p=>calcular_theta(p,soilParams)); const K=h.map(p=>calcular_K(p,soilParams));
                const q_face=new Array(Nx-1).fill(0).map((_,i)=>-(K[i]+K[i+1])/2*((h[i+1]-h[i])/dz-1));
                const D_m=1e-5,alpha_L=1;
                const D_face=q_face.map((q,i)=>alpha_L*Math.abs(q/((theta[i]+theta[i+1])/2))+D_m);
                
                let C_top_bc=0; if(tiempo_total>=appTime&&tiempo_total<appTime+3600)C_top_bc=1;
                
                const AC_lower=[],AC_diag=[],AC_upper=[],bC=[];
                for(let i=1;i<Nx-1;i++){
                    const D_up=D_face[i]*theta[i+1]/dz; const D_down=D_face[i-1]*theta[i-1]/dz;
                    const q_up=q_face[i]; const q_down=q_face[i-1];
                    AC_lower.push(q_down/2-D_down); AC_diag.push(theta[i]*dz*soluteParams.R/dt+(D_up+D_down)+(q_up-q_down)/2+theta[i]*dz*soluteParams.R*soluteParams.mu);
                    AC_upper.push(-q_up/2-D_up); bC.push(theta[i]*dz*soluteParams.R/dt*C_n[i]);
                }
                bC[N-1]-=AC_upper[N-1]*C_top_bc; AC_diag[0]+=AC_lower[0];

                const C_sol=thomasAlgorithm(AC_lower.slice(1),AC_diag,AC_upper,bC);
                C=[C_sol[0],...C_sol,C_top_bc];C.reverse();

                tiempo_total+=dt;
                if(tiempo_total>=time_to_plot){results.h.push([...h]);results.C.push([...C]);results.times.push(tiempo_total/3600);time_to_plot+=plot_interval}
            }

            const final_C_profile=C;const risk_value=final_C_profile[0];
            const mass_leached=final_C_profile.reduce((s,v,i)=>s+(i*dz<100?v:0),0)*dz;
            const total_mass=final_C_profile.reduce((s,v)=>s+v,0)*dz;
            self.postMessage({
                type:"result",zoneId:zone.id,results,
                summary:{risk_value,soilType:zone.soilType,soluteName:soluteParams.name,
                leaching_percentage:total_mass>1e-6?(mass_leached/total_mass)*100:0}
            });
        }
        self.onmessage=function(e){const{zones}=e.data;
        zones.forEach((zone,index)=>{self.postMessage({type:"progress",text:`Simulando Ambiente ${index+1}/${zones.length}...`});
        run_simulation_for_zone(zone)});self.postMessage({type:"done"})};
    </script>

    <script>
        // --- L√ìGICA DE LA INTERFAZ (HILO PRINCIPAL) ---
        let map, riskMap, drawingManager; let zones = [], riskPolygons = {};
        let simulationResults = {}; let selectedZoneId = null; let nextEventId = 0;
        const soilTypes = {'arena':'Arena','franco_arenoso':'Franco Arenoso','franco':'Franco','franco_limoso':'Franco Limoso','franco_arcilloso':'Franco Arcilloso','arcilla':'Arcilla'};
        const charts = {};

        function initMap() {
            const initialCoords = { lat: -34.921, lng: -57.954 };
            map = new google.maps.Map(document.getElementById('map'), { center: initialCoords, zoom: 14, mapTypeId: 'satellite' });
            riskMap = new google.maps.Map(document.getElementById('risk-map-display'), { center: initialCoords, zoom: 14, mapTypeId: 'satellite', disableDefaultUI: true });
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true, drawingControlOptions: { position: google.maps.ControlPosition.TOP_CENTER, drawingModes: ['polygon'] },
                polygonOptions: { fillColor: '#4299e1', fillOpacity: 0.5, strokeWeight: 2, strokeColor: '#FFFFFF', editable: true, zIndex: 1 },
            });
            drawingManager.setMap(map);
            google.maps.event.addListener(drawingManager, 'polygoncomplete', onPolygonComplete);
        }
        function onPolygonComplete(polygon) {
            const id = `zone_${new Date().getTime()}`; polygon.id = id;
            zones.push({ id, shape: polygon, soilType: 'franco', scenario: { initialPsi: -600, appTime: 1 * 3600, waterEvents: [] } });
            google.maps.event.addListener(polygon.getPath(), 'set_at', () => syncRiskMap());
            google.maps.event.addListener(polygon.getPath(), 'insert_at', () => syncRiskMap());
            renderZoneList(); syncRiskMap(); drawingManager.setDrawingMode(null);
        }
        function syncRiskMap() {
            Object.values(riskPolygons).forEach(p => p.setMap(null)); riskPolygons = {};
            const bounds = new google.maps.LatLngBounds();
            zones.forEach(zone => {
                const path = zone.shape.getPath();
                const riskPolygon = new google.maps.Polygon({ paths: path, strokeColor: '#FFFFFF', strokeOpacity: 0.8, strokeWeight: 2, fillColor: '#A0AEC0', fillOpacity: 0.6, map: riskMap });
                riskPolygon.id = zone.id; google.maps.event.addListener(riskPolygon, 'click', () => displayZoneResults(zone.id));
                riskPolygons[zone.id] = riskPolygon; path.getArray().forEach(latLng => bounds.extend(latLng));
            });
            if (!bounds.isEmpty()) { map.fitBounds(bounds); riskMap.fitBounds(bounds); }
        }
        function renderZoneList() {
            const container = document.getElementById('zone-list-container'); container.innerHTML = '';
            if (zones.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center">Dibuje en el mapa para comenzar.</p>'; return; }
            zones.forEach((zone, index) => {
                const item = document.createElement('div'); item.className = 'zone-item'; item.id = `zone-item-${zone.id}`;
                if (zone.id === selectedZoneId) item.classList.add('active');
                item.innerHTML = `
                    <div class="zone-header"><span class="font-bold">Ambiente ${index + 1}</span><select data-zone-id="${zone.id}" class="form-select text-sm w-1/2 soil-type">${Object.entries(soilTypes).map(([k, n]) => `<option value="${k}" ${zone.soilType===k?'selected':''}>${n}</option>`).join('')}</select></div>
                    <div class="zone-body grid grid-cols-2 gap-4">
                        <div><label class="form-label">Humedad Ini.:</label><select data-zone-id="${zone.id}" class="form-select text-sm initial-psi"><option value="-600" ${zone.scenario.initialPsi===-600?'selected':''}>Seco</option><option value="-150" ${zone.scenario.initialPsi===-150?'selected':''}>H√∫medo</option><option value="-50" ${zone.scenario.initialPsi===-50?'selected':''}>Cap. Campo</option></select></div>
                        <div><label class="form-label">Aplicaci√≥n (h):</label><input type="number" value="${zone.scenario.appTime/3600}" data-zone-id="${zone.id}" class="form-input text-sm app-time" min="0"></div>
                        <div class="col-span-2"><label class="form-label">Lluvia/Riego:</label><div class="event-list-local" id="event-list-${zone.id}"></div><button data-zone-id="${zone.id}" class="text-xs btn bg-blue-500 hover:bg-blue-600 mt-1 add-event-local">Agregar</button></div>
                    </div>`;
                container.appendChild(item);
                renderLocalEvents(zone);
            });
            document.querySelectorAll('.soil-type, .initial-psi, .app-time').forEach(el => el.addEventListener('change', updateZoneData));
            document.querySelectorAll('.add-event-local').forEach(el => el.addEventListener('click', addLocalEvent));
        }
        function updateZoneData(e) {
            const zone = zones.find(z => z.id === e.target.dataset.zoneId); if (!zone) return;
            const key = e.target.classList.contains('soil-type') ? 'soilType' : e.target.classList.contains('initial-psi') ? 'initialPsi' : 'appTime';
            const value = e.target.classList.contains('app-time') ? parseFloat(e.target.value) * 3600 : e.target.classList.contains('initial-psi') ? parseFloat(e.target.value) : e.target.value;
            if (key === 'soilType') zone.soilType = value; else zone.scenario[key] = value;
        }
        function addLocalEvent(e) {
            const zoneId = e.target.dataset.zoneId; const zone = zones.find(z => z.id === zoneId); if (!zone) return;
            zone.scenario.waterEvents.push({ id: `evt_${nextEventId++}`, amount: 20, time: (zone.scenario.waterEvents.length + 1) * 6 * 3600 });
            renderLocalEvents(zone);
        }
        function renderLocalEvents(zone) {
            const container = document.getElementById(`event-list-${zone.id}`); if(!container) return; container.innerHTML = '';
            zone.scenario.waterEvents.forEach(evt => {
                const item = document.createElement('div'); item.className = 'flex items-center gap-2 mt-1';
                item.innerHTML = `<input type="number" value="${evt.amount}" data-event-id="${evt.id}" placeholder="mm" class="form-input text-sm event-amount w-1/2"><input type="number" value="${evt.time/3600}" data-event-id="${evt.id}" placeholder="horas" class="form-input text-sm event-time w-1/2"><span data-zone-id="${zone.id}" data-event-id="${evt.id}" class="text-red-500 cursor-pointer font-bold remove-event">‚úñ</span>`;
                container.appendChild(item);
            });
            document.querySelectorAll('.event-amount, .event-time').forEach(el => el.addEventListener('change', updateLocalEvent));
            document.querySelectorAll('.remove-event').forEach(el => el.addEventListener('click', removeLocalEvent));
        }
        function updateLocalEvent(e) {
            const { eventId } = e.target.dataset;
            const zone = zones.find(z => z.scenario.waterEvents.some(evt => evt.id === eventId)); if(!zone) return;
            const event = zone.scenario.waterEvents.find(evt => evt.id === eventId); if(!event) return;
            if(e.target.classList.contains('event-amount')) event.amount = parseFloat(e.target.value);
            if(e.target.classList.contains('event-time')) event.time = parseFloat(e.target.value) * 3600;
        }
        function removeLocalEvent(e) {
            const { zoneId, eventId } = e.target.dataset; const zone = zones.find(z => z.id === zoneId); if (!zone) return;
            zone.scenario.waterEvents = zone.scenario.waterEvents.filter(evt => evt.id !== eventId);
            renderLocalEvents(zone);
        }

        document.getElementById('startSimBtn').addEventListener('click', () => {
            if (zones.length === 0) { alert("Defina al menos un ambiente."); return; }
            const chemicalKey = document.getElementById('agrochemical-selector').value;
            if (!chemicalKey) { alert("Seleccione un agroqu√≠mico."); return; }
            zones.forEach(z => z.scenario.chemicalKey = chemicalKey);
            
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('results-section').classList.remove('hidden'); document.getElementById('charts-section').classList.remove('hidden');
            simulationResults = {}; initializeCharts(); let resultsCounter = 0;
            
            const workerBlob = new Blob([document.getElementById('simulation-worker').textContent.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm, '')], { type: "text/javascript" });
            const worker = new Worker(window.URL.createObjectURL(workerBlob));
            worker.postMessage({ zones });

            worker.onmessage = function(e) {
                const { type, text, zoneId, results, summary } = e.data;
                if (type === 'progress') { document.getElementById('loading-text').textContent = text; }
                else if (type === 'result') {
                    resultsCounter++; simulationResults[zoneId] = { results, summary };
                    updateRiskMapForZone(zoneId, summary.risk_value);
                    if(resultsCounter === 1) displayZoneResults(zoneId); // Muestra el primero que llega
                } else if (type === 'done') {
                    document.getElementById('loading-overlay').style.display = 'none';
                    generateFinalRecommendation(); worker.terminate();
                }
            };
        });
        function initializeCharts() {
            ['pressure', 'moisture', 'solute'].forEach(type => { if(charts[type]) charts[type].destroy(); });
            const z_nodes=Array.from({length:151},(_,i)=>i*150/150);
            const createOptions=(label,lim=null)=>{const o={responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:label}},y:{title:{display:true,text:'Profundidad, z [cm]'},reverse:false}}};if(lim){o.scales.x.min=lim[0];o.scales.x.max=lim[1]}return o};
            charts.pressure = new Chart(document.getElementById('pressure-chart'), {type:'line', data:{labels:z_nodes,datasets:[]}, options:createOptions('Carga de Presi√≥n, œà [cm]')});
            charts.moisture = new Chart(document.getElementById('moisture-chart'), {type:'line', data:{labels:z_nodes,datasets:[]}, options:createOptions('Contenido de Humedad, Œ∏', [0, 0.5])});
            charts.solute = new Chart(document.getElementById('solute-chart'), {type:'line', data:{labels:z_nodes,datasets:[]}, options:createOptions('Concentraci√≥n Normalizada', [-0.1, 1.1])});
        }
        function displayZoneResults(zoneId) {
            selectedZoneId = zoneId; renderZoneList();
            const zoneIndex = zones.findIndex(z => z.id === zoneId) + 1;
            document.getElementById('charts-title').textContent = `Perfiles de Simulaci√≥n (Ambiente ${zoneIndex})`;
            const data = simulationResults[zoneId]; if (!data) return;
            
            initializeCharts(); const colors = ['#3182ce','#e53e3e','#38a169','#ed8936','#805ad5','#d53f8c'];
            data.results.times.forEach((time, i) => {
                const color = colors[i % colors.length];
                const hProfile = data.results.h[i]; const thetaProfile = hProfile.map(h => calcular_theta(h, soilDatabase[data.summary.soilType]));
                const CProfile = data.results.C[i];
                charts.pressure.data.datasets.push({label:`t=${time.toFixed(1)}h`,data:hProfile,borderColor:color,fill:false,pointRadius:0});
                charts.moisture.data.datasets.push({label:`t=${time.toFixed(1)}h`,data:thetaProfile,borderColor:color,fill:false,pointRadius:0});
                charts.solute.data.datasets.push({label:`t=${time.toFixed(1)}h`,data:CProfile,borderColor:color,fill:false,pointRadius:0});
            });
            Object.values(charts).forEach(c => c.update('none'));
        }
        function getRiskColor(v){if(v>0.1)return'#e53e3e';if(v>0.01)return'#ed8936';return'#38a169'}
        function getRiskText(v){if(v>0.1)return'Alto';if(v>0.01)return'Moderado';return'Bajo'}
        function updateRiskMapForZone(zoneId,riskValue){const p=riskPolygons[zoneId];if(p)p.setOptions({fillColor:getRiskColor(riskValue)})}
        function generateFinalRecommendation() {
            const cont = document.getElementById('final-recommendation'); let s = { high: [], mod: [], low: [] };
            zones.forEach((z, i) => {
                const res = simulationResults[z.id]; if (!res) return;
                const riskLvl = getRiskText(res.summary.risk_value);
                const entry = { name: `Ambiente ${i + 1} (${soilTypes[res.summary.soilType]})`, leaching: res.summary.leaching_percentage.toFixed(1) };
                if (riskLvl === 'Alto') s.high.push(entry); else if (riskLvl === 'Moderado') s.mod.push(entry); else s.low.push(entry);
            });
            let html = `<h3 class="font-bold text-lg mb-2">S√≠ntesis General</h3><p class="mb-4">Simulaci√≥n completada para ${zones.length} ambientes. Se detect√≥ riesgo <strong>Alto</strong> en <strong>${s.high.length}</strong>, <strong>Moderado</strong> en <strong>${s.mod.length}</strong> y <strong>Bajo</strong> en <strong>${s.low.length}</strong>.</p>`;
            if (s.high.length > 0) {html += `<div class="p-3 rounded-lg bg-red-100 border border-red-300 mb-3"><h4 class="font-bold text-red-800">üî¥ Acci√≥n Recomendada para Zonas de Alto Riesgo</h4><p class="text-sm text-red-700 mt-1">Para los ambientes: <strong>${s.high.map(e => e.name).join(', ')}</strong>, se recomienda:</p><ul class="list-disc list-inside text-sm text-red-700 mt-1"><li><strong>No aplicar</strong> bajo las condiciones de lluvia/riego simuladas.</li><li>Considerar el uso de un producto alternativo con mayor adsorci√≥n (Koc m√°s alto).</li><li>Retrasar la aplicaci√≥n hasta un per√≠odo sin pron√≥stico de lluvias intensas.</li><li>En estas zonas se estim√≥ una p√©rdida por lixiviaci√≥n (debajo de 100cm) de hasta <strong>${Math.max(...s.high.map(e=>parseFloat(e.leaching)))}%</strong>.</li></ul></div>`;}
            if (s.mod.length > 0) {html += `<div class="p-3 rounded-lg bg-yellow-100 border border-yellow-300 mb-3"><h4 class="font-bold text-yellow-800">üü° Precauci√≥n para Zonas de Riesgo Moderado</h4><p class="text-sm text-yellow-700 mt-1">En los ambientes: <strong>${s.mod.map(e => e.name).join(', ')}</strong>, considere reducir la dosis de aplicaci√≥n o asegurar que no ocurran eventos h√≠dricos adicionales a los planificados.</li></ul></div>`;}
            if (s.low.length > 0) {html += `<div class="p-3 rounded-lg bg-green-100 border border-green-300"><h4 class="font-bold text-green-800">üü¢ Aplicaci√≥n Segura en Zonas de Bajo Riesgo</h4><p class="text-sm text-green-700 mt-1">La aplicaci√≥n en los ambientes: <strong>${s.low.map(e => e.name).join(', ')}</strong> parece segura bajo las condiciones simuladas.</li></ul></div>`;}
            cont.innerHTML = html;
        }
        
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCWnFvt9RuvfJT3ZkiqoNFJKNLxT_qLmSo&libraries=drawing&callback=initMap`;
        script.async = true; script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
